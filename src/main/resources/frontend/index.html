<html lang="en">
<body>
<h1 class="error-message" style="color:red"></h1>
<p>Your name: <label>
  <input class="my-name" onchange="onPlayerNameChange()" oninput="onPlayerNameChange()">
</label></p>
<p>Ticket: <label>
  <input class="ticket-name" onchange="onSetTicket()" oninput="onSetTicket()">
</label></p>
<p>
  <button class="clear-all" onClick="onClearEverything()">Clear</button>
  <button class="show-votes" onClick="onShowVotes()">Show votes</button>
</p>
<p class="current-vote">Your vote: ?</p>
<button class="vote-half" onClick="onVote('0.5')">0.5</button>
<button class="vote-1" onClick="onVote('1')">1</button>
<button class="vote-2" onClick="onVote('2')">2</button>
<button class="vote-3" onClick="onVote('3')">3</button>
<button class="vote-5" onClick="onVote('5')">5</button>
<button class="vote-8" onClick="onVote('8')">8</button>
<button class="vote-forever" onClick="onVote('∞')">∞</button>
<button class="vote-dunno" onClick="onVote('?')">?</button>
<p>Votes:</p>
<table class="votes-table"></table>
<script>
  const urlParams = new URLSearchParams(window.location.search);
  const sessionId = urlParams.get('sessionId');

  const socketProtocol = location.protocol === 'https:' ? 'ws:' : 'wss:';
  const socket = new WebSocket(`${socketProtocol}//${window.location.host}/${sessionId}`);
  let socketClosed = false;

  const log = (message, ...args) => console.log(message, [...args]);
  const send = message => {
    if (socketClosed) {
      showError("Session is closed or connection has been interrupted. Please refresh the page to continue.");
    } else {
      log('sending', message);
      socket.send(message);
    }
  };
  const showError = error => {
    document.getElementsByClassName('error-message').textContent = error;
  };

  socket.onopen = () => {
    log('connection established');
  };

  socket.onmessage = event => {
    log('data received from server', event.data);
    if (event.data.startsWith('STATE:')) {
      const messageSplit = event.data.split(':');
      let newTicketName = messageSplit[1];
      log('setting ticket name to', newTicketName);
      document.getElementsByClassName("ticket-name").item(0).value = newTicketName;
      const votesTable = document.getElementsByClassName('votes-table').item(0);
      votesTable.innerHTML = '';
      if (messageSplit.length > 2) {
        for (let i = 2; i < messageSplit.length; i += 2) {
          // clear the whole table
          const playerName = messageSplit[i];
          const playerVote = messageSplit[i + 1];
          const row = document.createElement('TR');
          votesTable.appendChild(row);

          const playerNameData = document.createElement('TD');
          playerNameData.textContent = playerName;
          row.appendChild(playerNameData);

          const playerVoteData = document.createElement('TD');
          playerVoteData.textContent = playerVote;
          row.appendChild(playerVoteData);
        }
      }
    }
  };

  socket.onclose = event => {
    socketClosed = true;
    if (event.wasClean) {
      log(`connection closed; code: ${event.code}, reason: ${event.reason}`);
    } else {
      log('connection died');
    }
  };

  socket.onerror = error => {
    showError(`socket error: ${error.message}`);
  };

  function onSetTicket() {
    const newTicket = document.getElementsByClassName("ticket-name").item(0).value;
    log('updating ticket', newTicket);
    send(`SET_TICKET:${newTicket}`)
  }

  function onPlayerNameChange() {
    const newPlayerName = document.getElementsByClassName("my-name").item(0).value;
    log('updating player name', newPlayerName);
    send(`NEW_PLAYER:${newPlayerName}`)
  }

  function onVote(voteValue) {
    log('updating own vote', voteValue);
    document.getElementsByClassName("current-vote").item(0).textContent = `Your vote: ${voteValue}`;
    send(`VOTE:${voteValue}`)
  }

  function onClearEverything() {
    log('clearing everything');
    send(`CLEAR_EVERYTHING:ignore lol`)
  }

  function onShowVotes() {
    log('showing votes');
    send(`SHOW_VOTES:ignore lol`)
  }

</script>
</body>
</html>
